name: iOS Build

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter Pub Get
        run: flutter pub get

      - name: Install CocoaPods
        run: |
          cd ios
          pod install

      - name: Import signing certificate (optional)
        if: secrets.APPLE_CERTIFICATE != '' && secrets.APPLE_CERTIFICATE_PASSWORD != ''
        run: |
          echo "Importing certificate"
          echo "${{ secrets.APPLE_CERTIFICATE }}" | base64 --decode > /tmp/codesign_cert.p12
          KEYCHAIN=build.keychain
          security create-keychain -p "" "$KEYCHAIN"
          security import /tmp/codesign_cert.p12 -k ~/Library/Keychains/$KEYCHAIN -P "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          security list-keychains -s ~/Library/Keychains/$KEYCHAIN
          security default-keychain -s ~/Library/Keychains/$KEYCHAIN
          security unlock-keychain -p "" ~/Library/Keychains/$KEYCHAIN

      - name: Install provisioning profile (optional)
        if: secrets.APPLE_PROVISIONING_PROFILE != ''
        run: |
          echo "Installing provisioning profile"
          echo "${{ secrets.APPLE_PROVISIONING_PROFILE }}" | base64 --decode > /tmp/profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp /tmp/profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      - name: Build IPA (signed if secrets provided)
        env:
          EXPORT_METHOD: ${{ secrets.EXPORT_METHOD }}
        run: |
          # set default export method if not provided
          if [ -z "${EXPORT_METHOD}" ]; then
            EXPORT_METHOD=ad-hoc
          fi
          echo "Using export method: ${EXPORT_METHOD}"
          if [ -n "${{ secrets.APPLE_CERTIFICATE }}" ] && [ -n "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" ]; then
            flutter build ipa --export-method=${EXPORT_METHOD}
          else
            flutter build ipa --no-codesign
          fi

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ios/ipa/*.ipa
